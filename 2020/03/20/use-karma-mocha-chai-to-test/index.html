<!DOCTYPE html><html lang="zh-CN"><head><link rel=manifest href=/manifest.json><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="theme-color" content="#ffffff"><link rel="manifest" href="/manifest.json?v=2.1.1"><link rel="icon" href="/assets/icons/icon-16x16.png?v=2.1.1" type="image/png" sizes="16x16"><link rel="icon" href="/assets/icons/icon-32x32.png?v=2.1.1" type="image/png" sizes="32x32"><link rel="apple-touch-icon" href="/assets/icons/apple-touch-icon.png?v=2.1.1" sizes="180x180"><link rel="mask-icon" href="/assets/icons/safari-pinned-tab.svg?v=2.1.1" color="#54bcff"><meta name="msapplication-TileImage" content="/assets/icons/icon-144x144.png"><meta name="msapplication-TileColor" content="#000000"><meta name="google-site-verification" content="_dxRdKposlAngL4xRoCTrJu0sZ7Pp_RhlBF9inxcD5w"><meta name="msvalidate.01" content="6A508F795A82FADAC671AFCB9848929F"><meta name="baidu-site-verification" content="UYjZUCoORR"><meta name="360-site-verification" content="b926bfcb0e6034f32ac4700700a812f5"><meta name="sogou_site_verification" content="hbRL4tRKAg"><meta name="description" content="本文属于对配置项目的总结，不会过多讲解相关知识。阅读正文之前，你需要了解并使用过 webpack、Babel，了解 ES6、CommonJS 规范，了解过前端单元测试。">
<meta name="keywords" content="单元测试,Karma,Mocha,Chai">
<meta property="og:type" content="article">
<meta property="og:title" content="使用 Karma + Mocha + Chai 搭建 Web 单元测试环境">
<meta property="og:url" content="https://liuyib.github.io/2020/03/20/use-karma-mocha-chai-to-test/">
<meta property="og:site_name" content="Liuyib&#39;s Blog">
<meta property="og:description" content="本文属于对配置项目的总结，不会过多讲解相关知识。阅读正文之前，你需要了解并使用过 webpack、Babel，了解 ES6、CommonJS 规范，了解过前端单元测试。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://liuyib.github.io/assets/posts/use-karma-mocha-chai-to-test/karma-init.png">
<meta property="og:image" content="https://liuyib.github.io/assets/posts/use-karma-mocha-chai-to-test/karma-default-reporter.png">
<meta property="og:image" content="https://liuyib.github.io/assets/posts/use-karma-mocha-chai-to-test/karma-spec-reporter.png">
<meta property="og:image" content="https://liuyib.github.io/assets/posts/use-karma-mocha-chai-to-test/coverage-in-browser-1.png">
<meta property="og:image" content="https://liuyib.github.io/assets/posts/use-karma-mocha-chai-to-test/coverage-in-browser-2.png">
<meta property="og:image" content="https://img.shields.io/travis/liuyib/karma-mocha-demo.svg">
<meta property="og:image" content="https://img.shields.io/codecov/c/github/liuyib/karma-mocha-demo.svg">
<meta property="og:updated_time" content="2020-10-04T08:35:34.865Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://liuyib.github.io/assets/posts/use-karma-mocha-chai-to-test/karma-init.png"><title>使用 Karma + Mocha + Chai 搭建 Web 单元测试环境 | Liuyib's Blog</title><link ref="canonical" href="https://liuyib.github.io/2020/03/20/use-karma-mocha-chai-to-test/"><link rel="alternate" href="/atom.xml" type="application/atom+xml"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.1.1"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="dns-prefetch" href="https://hm.baidu.com"><link rel="dns-prefetch" href="https://tajs.qq.com"><script src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" data-ad-client="ca-pub-2577876740331235" async="" data-pjax=""></script><script src="https://www.googletagmanager.com/gtag/js?id=UA-146413033-1" async="" data-pjax=""></script><script data-pjax="">if (window.location.hostname !== 'localhost') {
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'UA-146413033-1');
}</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement('script');
  hm.src = 'https://hm.baidu.com/hm.js?2be584e2ddc153d81489b57ba106c8c0';
  hm.async = true;

  if (true) {
    hm.setAttribute('data-pjax', '');
  }
  var s = document.getElementsByTagName('script')[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>(function() {
  var hm = document.createElement('script');
  hm.src = 'https://tajs.qq.com/stats?sId=66465986';
  hm.async = true;

  if (true) {
    hm.setAttribute('data-pjax', '');
  }
  var s = document.getElementsByTagName('script')[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":4},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":true},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"carbon","highlight":"light","wordWrap":false},
  reward: true,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: {"colWidth":"220px","gapX":"10px"},
  lazyload: true,
  pjax: {"avoidBanner":true},
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: {"switchPost":true},
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="javascript:;" onclick="return false;"><span class="header-nav-menu-item__icon"><i class="fas fa-feather-alt"></i></span><span class="header-nav-menu-item__text">文章</span></a><div class="header-nav-submenu"><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/archives/"><span class="header-nav-submenu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-submenu-item__text">归档</span></a></div><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/categories/"><span class="header-nav-submenu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-submenu-item__text">分类</span></a></div><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/tags/"><span class="header-nav-submenu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-submenu-item__text">标签</span></a></div></div></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="javascript:;" onclick="return false;"><span class="header-nav-menu-item__icon"><i class="fas fa-flask"></i></span><span class="header-nav-menu-item__text">实验室</span></a><div class="header-nav-submenu"><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="https://github.com/liuyib/hexo-theme-stun" target="_blank" rel="noopener"><span class="header-nav-submenu-item__text">🦄 Stun</span></a></div></div></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="javascript:;" onclick="return false;"><span class="header-nav-menu-item__icon"><i class="fas fa-fingerprint"></i></span><span class="header-nav-menu-item__text">关于</span></a><div class="header-nav-submenu"><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/about/"><span class="header-nav-submenu-item__icon"><i class="fas fa-user"></i></span><span class="header-nav-submenu-item__text">作者</span></a></div><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/reprint/"><span class="header-nav-submenu-item__icon"><i class="fas fa-reply"></i></span><span class="header-nav-submenu-item__text">转载</span></a></div></div></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="javascript:;" onclick="return false;"><span class="header-nav-menu-item__icon"><i class="fas fa-angle-double-down"></i></span><span class="header-nav-menu-item__text">其他</span></a><div class="header-nav-submenu"><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/gallery/"><span class="header-nav-submenu-item__icon"><i class="fas fa-images"></i></span><span class="header-nav-submenu-item__text">相册</span></a></div><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/friends/"><span class="header-nav-submenu-item__icon"><i class="fas fa-hand-spock"></i></span><span class="header-nav-submenu-item__text">友链</span></a></div></div></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">Liuyib's Blog</div><div class="header-banner-info__subtitle">write code and love life</div></div><div class="header-banner-arrow"><div class="header-banner-arrow__icon"><i class="fas fa-angle-down"></i></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">使用 Karma + Mocha + Chai 搭建 Web 单元测试环境</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2020-03-20</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2020-10-04</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">5k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">34分</span></span><span class="post-meta-item post-meta-item--visitors"><span class="post-meta-item__icon"><i class="fas fa-eye"></i></span><span class="post-meta-item__info">阅读次数</span><span class="post-meta-item__value" id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body"><p>本文属于对配置项目的总结，不会过多讲解相关知识。阅读正文之前，你需要了解并使用过 webpack、Babel，了解 ES6、CommonJS 规范，了解过前端单元测试。</p>
<a id="more"></a>

        <h2 id="适用场景"   >
          <a href="#适用场景" class="heading-link"><i class="fas fa-link"></i></a>适用场景</h2>
      
<p>说明一下本文的适用场景：</p>
<ol>
<li>项目使用了 ES6 或 CommonJS 等模块化规范，需要打包编译才能在浏览器里运行。</li>
<li>需要进行 DOM, BOM 相关的单元测试。</li>
</ol>
<p>如果你的项目不适用于以上两点，那么没必要使用 Karma，直接使用 Jest 或 Mocha + Chai + Istanbul 组合即可。</p>

        <h2 id="为什么不用-jest"   >
          <a href="#为什么不用-jest" class="heading-link"><i class="fas fa-link"></i></a>为什么不用 Jest</h2>
      
<p><span class="exturl"><a class="exturl__link"   href="https://jestjs.io/"  target="_blank" rel="noopener">Jest</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 是 Facebook 开源的测试框架，简单易用，只需少量的配置即可开始使用。它使用了 JSDOM 模拟浏览器环境来支持测试，提高了性能，但是也带来了 JSDOM 的局限性。最大的问题是：不能方便的在真实的浏览器中测试。因此难免会使得测试结果不那么准确，毕竟模拟环境无法媲美真实环境。</p>
<p>如果项目涉及 DOM，BOM 相关的一些测试，就不必浪费时间在 Jest 上折腾了，直接使用 Karma 手动搭建测试环境反而会更容易。</p>

        <h2 id="认识-karma"   >
          <a href="#认识-karma" class="heading-link"><i class="fas fa-link"></i></a>认识 Karma</h2>
      
<p><span class="exturl"><a class="exturl__link"   href="https://karma-runner.github.io/latest/index.html"  target="_blank" rel="noopener">Karma</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 是一个开源的测试运行器（Test Runner），它的最大优势是：允许你在多种真实的浏览器环境中测试代码。能够和主流的测试框架（Mocha, Jasmine, QUnit）很好的结合，并且支持 webpack 和 Babel 的使用。</p>
<p>不过，Karma 的配置没有那么简单，其官方文档中，并没有介绍如何从 0 到 1 进行配置，因此对新手来说不够友好。</p>

        <h2 id="使用-karma"   >
          <a href="#使用-karma" class="heading-link"><i class="fas fa-link"></i></a>使用 Karma</h2>
      
<p>在本文中，我们会用 NPM 来管理依赖包，所以先初始化它的配置文件 <code>package.json</code>：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm init -y</span><br></pre></td></tr></table></div></figure>
<blockquote>
<p><code>-y</code>（<code>--yes</code>）参数表示不进行询问，直接使用默认的配置。</p>
</blockquote>
<p>然后，项目级安装 Karma：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install --save-dev karma</span><br></pre></td></tr></table></div></figure>
<p>为了方便使用，我们将其全局安装一下（这里也可以不全局安装，直接跳过）：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install --global karma</span><br></pre></td></tr></table></div></figure>
<p>Karma 配置文件的命名规则是 <code>[name].conf.js</code>。你可以选择手动编写 Karma 的配置文件，不过更推荐使用 CLI 来自动生成：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果你全局安装了 Karma，执行这个</span></span><br><span class="line">$ karma init ./karma.conf.js</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果你没有全局安装 Karma，执行这个</span></span><br><span class="line">$ ./node_modules/.bin/karma init ./karma.conf.js</span><br></pre></td></tr></table></div></figure>
<p>接下来，根据一系列的提问进行选择（本文选择的内容如图所示）：</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="/assets/posts/use-karma-mocha-chai-to-test/karma-init.png"  alt="" />
      </p>
<ol>
<li>想要使用的测试框架 <code>mocha</code> 或 <code>jasmine</code>
<blockquote>
<p>两者选其一即可，也可以指定其它的，本文以 <code>mocha</code> 为例。</p>
</blockquote>
</li>
<li>你的项目是否用到了 <code>Require.js</code>
<blockquote>
<p><span class="exturl"><a class="exturl__link"   href="http://www.requirejs.org/"  target="_blank" rel="noopener">Require.js</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 是异步加载规范（AMD）的实现。如果你不清楚，直接选 <code>no</code>。</p>
</blockquote>
</li>
<li>想要测试的浏览器环境
<blockquote>
<p>可选值：<code>Chrome</code>, <code>ChromeHeadLess</code>, <code>ChromeCanary</code>, <code>Firefox</code>, <code>Safari</code>, <code>IE</code>, <code>Opera</code>, <code>PhantomJS</code>。<br />
可以指定单个或多个，本文以 <code>Chrome</code> 为例。</p>
</blockquote>
</li>
<li>源文件和测试文件的路径
<blockquote>
<p>先输入源文件的路径：<code>src/**/*.js</code>（举例），回车之后，再输入测试文件的路径：<code>test/**/*.js</code>（举例）</p>
</blockquote>
</li>
<li>需要排除的文件</li>
<li>是否允许 Karma 监听所有文件的变动，并在文件发生变动时，重新执行测试</li>
</ol>
<p>根据上面选择的项，会自动生成以下内容（这里去掉了默认注释，并加上了中文注释）：</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// karma.conf.js</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">config</span>) </span>&#123;</span><br><span class="line">  config.set(&#123;</span><br><span class="line">    <span class="comment">// 路径前缀</span></span><br><span class="line">    basePath: <span class="string">""</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用到的库或框架</span></span><br><span class="line">    <span class="comment">// 添加到这里表示注册为全局变量（不用反复在代码中 import 或 require）</span></span><br><span class="line">    frameworks: [<span class="string">"mocha"</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 需要提供给浏览器的源文件和测试文件</span></span><br><span class="line">    files: [<span class="string">"src/**/*.js"</span>, <span class="string">"test/**/*.js"</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 需要排除的文件</span></span><br><span class="line">    exclude: [],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将文件提供给浏览器之前，进行预处理</span></span><br><span class="line">    preprocessors: &#123;&#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 测试信息报告器</span></span><br><span class="line">    reporters: [<span class="string">"progress"</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在浏览器中运行的端口</span></span><br><span class="line">    port: <span class="number">9876</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否将输出信息彩色显示（用于 reporters 和日志信息）</span></span><br><span class="line">    colors: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 显示日志的级别</span></span><br><span class="line">    logLevel: config.LOG_INFO,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否监听所有文件的变动</span></span><br><span class="line">    autoWatch: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 需要测试的浏览器环境</span></span><br><span class="line">    browsers: [<span class="string">"Chrome"</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果为 true 的话，Karma 将捕获浏览器，运行测试，并自动退出</span></span><br><span class="line">    <span class="comment">// 使用持续集成时会用到该选项（这里先默认，后面会说明）</span></span><br><span class="line">    singleRun: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 允许同时启动的浏览器个数，默认无限个</span></span><br><span class="line">    concurrency: <span class="literal">Infinity</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>

        <h2 id="安装插件"   >
          <a href="#安装插件" class="heading-link"><i class="fas fa-link"></i></a>安装插件</h2>
      
<p>初始化 Karma 的配置文件后，首先需要根据你选择的内容，安装相关插件：</p>
<ol>
<li>
<p>本文选择了 Mocha 测试框架，需要安装 <code>mocha</code> 和 <code>karma-mocha</code> 插件：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install --save-dev mocha karma-mocha</span><br></pre></td></tr></table></div></figure>
<blockquote>
<p>其中 <code>karma-mocha</code> 的作用是让 <code>mocha</code> 可以在 Karma 中工作。</p>
</blockquote>
</li>
<li>
<p>测试的浏览器我选择了 Chrome，需要安装 <code>karma-chrome-launcher</code> 插件：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install --save-dev karma-chrome-launcher</span><br></pre></td></tr></table></div></figure>
<blockquote>
<p>该插件用于在测试的时候，自动控制对应的浏览器，你不需要对浏览器进行任何操作，因为 Karma 仅仅是借用浏览器的环境而已。</p>
<p>如果你选择了其他浏览器，安装对应的插件即可。例如选择 FireFox，则需要安装 <code>karma-firefox-launcher</code> 插件。</p>
</blockquote>
</li>
</ol>
<p>这里只是安装了最基本的插件，其它插件的安装会在后面用到时说明。</p>
<p>为了方便读者，我为本文建了一个 Github 仓库：<a href="https://github.com/liuyib/karma-mocha-demo" target="_blank" rel="noopener"><br />
liuyib/karma-mocha-demo</a>。如果某些修改的地方不太清楚，可以参考该仓库中的 commit 记录。到此为止，本文示例中所做的修改在<span class="exturl"><a class="exturl__link"   href="https://github.com/liuyib/karma-mocha-demo/commit/cfb20fd3a663bfe819350895edb9944d0cceb8b8"  target="_blank" rel="noopener">这里</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>查看。</p>

        <h2 id="编写代码"   >
          <a href="#编写代码" class="heading-link"><i class="fas fa-link"></i></a>编写代码</h2>
      
<p>为了使本文的示例更具有参考性，这里新建两个模块 <code>utils.js</code> 和 <code>main.js</code>。</p>
<p>在 <code>src</code> 目录下，新建 <code>utils.js</code>，编写如下代码：</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utils.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 一个加法函数，返回两数之和</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>然后，在 <code>src</code> 目录下，新建 <code>main.js</code>，编写如下代码：</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; add &#125; <span class="keyword">from</span> <span class="string">"./utils"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> main = <span class="function"><span class="keyword">function</span>(<span class="params">selector</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> elem = <span class="built_in">document</span>.querySelector(selector);</span><br><span class="line"></span><br><span class="line">  elem.addEventListener(<span class="string">"click"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> value = <span class="built_in">parseInt</span>(elem.innerText, <span class="number">10</span>);</span><br><span class="line">    elem.innerText = add(value, <span class="number">1</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> main;</span><br></pre></td></tr></table></div></figure>
<p>上面这段代码的作用不难看出，就是根据传入的选择器获取 DOM 元素，然后监听该元素的 <code>click</code> 事件，当用户点击时，将该元素内容 + 1（为了方便演示，假设该元素内容是数字）。</p>
<p>下文中我们会介绍到，如何测试“DOM 相关的操作”和“需要用户交互的逻辑”。</p>

        <h2 id="使用-babel"   >
          <a href="#使用-babel" class="heading-link"><i class="fas fa-link"></i></a>使用 Babel</h2>
      
<p>由于我们的代码中用到了 ES6 语法，所以需要用 Babel 编译一下，安装 Babel 和 webpack 相关插件：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install --save-dev @babel/core @babel/preset-env babel-loader webpack</span><br></pre></td></tr></table></div></figure>
<blockquote>
<p>这里安装的依赖版本分别为 <code>babel 7.x</code> | <code>babel-loader 8.x</code> | <code>webpack 4.x</code></p>
<p>详见：<span class="exturl"><a class="exturl__link"   href="https://github.com/babel/babel-loader#install"  target="_blank" rel="noopener">https://github.com/babel/babel-loader#install</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</blockquote>
<ul>
<li><code>@babel/core</code>（旧版名称 <code>babel-core</code>，已废弃，不推荐）：是 Babel 语法分析的核心，很多 Babel 插件依赖于它。</li>
<li><code>@babel/preset-env</code>（旧版名称 <code>babel-preset-env</code>，已废弃，不推荐）：会检测你的配置或运行环境，将代码编译到合适版本。</li>
<li><code>babel-loader</code>：允许你使用 Babel 和 webpack 转译 JavaScript 文件。</li>
<li><code>webpack</code>：负责打包编译。</li>
</ul>
<blockquote>
<p>如果使用 CommonJS 规范，并且想要运行在浏览器中，那么也需要使用 Babel 编译。</p>
</blockquote>

        <h2 id="配置-webpack"   >
          <a href="#配置-webpack" class="heading-link"><i class="fas fa-link"></i></a>配置 webpack</h2>
      
<p>首先，我们需要安装 <code>karma-webpack</code> 插件：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install --save-dev karma-webpack</span><br></pre></td></tr></table></div></figure>
<blockquote>
<p>该插件的作用是让 <code>webpack</code> 可以在 Karma 中工作。</p>
</blockquote>
<p>然后，参照该插件的<span class="exturl"><a class="exturl__link"   href="https://github.com/webpack-contrib/karma-webpack"  target="_blank" rel="noopener">文档</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>进行配置，修改 <code>karma.conf.js</code> 文件：</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">preprocessors: &#123;</span><br><span class="line">  <span class="comment">// 匹配源文件，并使用 webpack 进行预处理</span></span><br><span class="line">  <span class="string">'src/**/*.js'</span>: [<span class="string">'webpack'</span>],</span><br><span class="line">  <span class="comment">// 匹配测试文件，并使用 webpack 进行预处理</span></span><br><span class="line">  <span class="string">'test/**/*.js'</span>: [<span class="string">'webpack'</span>]</span><br><span class="line">&#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></div></figure>
<p>上面的配置作用是：在文件提供给浏览器运行之前，使用 webpack 进行预处理。当然你可以继续添加其它插件来处理文件，用法同上，即：<code>['插件名称', '插件名称', ...]</code>。</p>
<p>接下来，你需要自己配置 webpack，在 <code>karma.conf.js</code> 文件里添加 <code>webpack: {}</code> 配置项，然后参照 webpack <span class="exturl"><a class="exturl__link"   href="https://webpack.js.org/concepts/"  target="_blank" rel="noopener">文档</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>进行配置，下面是一些配置示例。</p>
<p>如果你的项目只需要把 ES6+ 语法编译到 ES5，那么只进行下面的配置即可，修改 <code>karma.conf.js</code> 文件：</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">webpack: &#123;</span><br><span class="line">  mode: <span class="string">'development'</span>,</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// 匹配 JavaScript 文件</span></span><br><span class="line">        test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        <span class="comment">// 排除 node_modules 和 bower_components 目录</span></span><br><span class="line">        exclude: <span class="regexp">/(node_modules|bower_components)/</span>,</span><br><span class="line">        use: &#123;</span><br><span class="line">          <span class="comment">// 使用的 loader</span></span><br><span class="line">          loader: <span class="string">'babel-loader'</span>,</span><br><span class="line">          <span class="comment">// 传递给 babel-loader 的参数</span></span><br><span class="line">          options: &#123;</span><br><span class="line">            presets: [<span class="string">'@babel/preset-env'</span>]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></div></figure>
<p>其中，传递给 <code>babel-loader</code> 的参数，更<strong>推荐</strong>写入 <code>.babelrc</code> 文件中：</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .babelrc</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"presets"</span>: [<span class="string">"@babel/preset-env"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>对于本文的示例代码来说，只需要将 ES6+ 语法编译到 ES5，上面的配置足够使用。因此，如果你需要更复杂的配置，请自行查看 webpack 的文档。</p>
<blockquote>
<p>到此为止，读者可以访问<span class="exturl"><a class="exturl__link"   href="https://github.com/liuyib/karma-mocha-demo/commit/fc4c77e421c9ae297c604418bfb1697c94b12817"  target="_blank" rel="noopener">这里</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>，查看所做的修改。</p>
</blockquote>

        <h2 id="启动-karma"   >
          <a href="#启动-karma" class="heading-link"><i class="fas fa-link"></i></a>启动 Karma</h2>
      
<p>在 <code>package.json</code> 中添加一条 NPM 指令：</p>
<figure class="highlight"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">"script": &#123;</span><br><span class="line">  "test": "karma start ./karma.conf.js"</span><br><span class="line">&#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></div></figure>
<p>然后在命令行中执行 <code>npm run test</code>，如果控制台中没有报错信息，并且 Karma 自动打开了你选择的浏览器，证明你的上述配置没有问题。否则，你需要检查之前的配置是否正确。</p>

        <h2 id="编写测试代码"   >
          <a href="#编写测试代码" class="heading-link"><i class="fas fa-link"></i></a>编写测试代码</h2>
      
<p>首先，安装断言库 <code>chai</code> 和 <code>karma-chai</code>：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install --save-dev chai karma-chai</span><br></pre></td></tr></table></div></figure>
<blockquote>
<p>其中 <code>karma-chai</code> 的作用是让 <code>chai</code> 可以在 Karma 中工作。</p>
</blockquote>
<p>然后全局引入 Chai，修改 <code>karma.conf.js</code> 文件：</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">frameworks: [<span class="string">'mocha'</span>, <span class="string">'chai'</span>],</span><br><span class="line">...</span><br></pre></td></tr></table></div></figure>
<p>你也可以不全局引入，那么你必须在文件中，手动进行 <code>import</code> 或 <code>require</code>：</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; expect &#125; form <span class="string">'chai'</span>;         <span class="comment">// ES6</span></span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line"><span class="keyword">const</span> expect = <span class="built_in">require</span>(<span class="string">'chai'</span>).expect; <span class="comment">// CommonJS</span></span><br></pre></td></tr></table></div></figure>
<p>通常，测试文件与所要测试的源文件同名，但是后缀名为 <code>.test.js</code>（表示测试）或 <code>.spec.js</code>（表示规格）。</p>
<p>接下来，我们开始编写测试代码。首先来测试 <code>utils</code> 模块，在 <code>test</code> 目录下，新建 <code>utils.test.js</code>：</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utils.test.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; add &#125; <span class="keyword">from</span> <span class="string">"../src/utils"</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"utils::add test"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  it(<span class="string">"should 3 when add(1, 2) return"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    expect(add(<span class="number">1</span>, <span class="number">2</span>)).to.equal(<span class="number">3</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></div></figure>
<p>上述代码中：</p>
<ul>
<li>
<p><code>describe</code> 块称为“测试套件（test suite）”，表示一组相关的测试。它是一个函数，第一个参数是测试套件的名称，第二个参数是一个实际执行的函数。</p>
</li>
<li>
<p><code>it</code> 块称为“测试用例（test case）”，表示一个单独的测试，是测试的最小单位。它也是一个函数，第一个参数是测试用例的名称，第二个参数是一个实际执行的函数。</p>
</li>
</ul>
<p>本文使用了 expect 风格的断言，其特点是更接近自然语言。例如上面的代码中：<code>expect(add(1, 2)).to.equal(3)</code>，意思是“期望 <code>add(1, 2)</code> 等于 <code>3</code>”。如果这个断言为真，则对应测试用例通过，否则不通过。</p>
<p>然后，再来测试 <code>main</code> 模块，在 <code>test</code> 目录下，新建 <code>main.test.js</code>：</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.test.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> main <span class="keyword">from</span> <span class="string">"../src/main"</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"main::DOM test"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 钩子函数</span></span><br><span class="line">  beforeEach(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 向页面的 body 元素中添加 DOM 元素，来辅助测试</span></span><br><span class="line">    <span class="built_in">document</span>.body.innerHTML = <span class="string">'&lt;button id="btn"&gt;0&lt;/button&gt;'</span>;</span><br><span class="line"></span><br><span class="line">    main(<span class="string">"#btn"</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">"should 1 when button is clicked once"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 获取前面添加的元素</span></span><br><span class="line">    <span class="keyword">var</span> btn = <span class="built_in">document</span>.querySelector(<span class="string">"#btn"</span>);</span><br><span class="line">    <span class="comment">// 模拟用户点击</span></span><br><span class="line">    btn.click();</span><br><span class="line"></span><br><span class="line">    expect(btn.innerText).to.equal(<span class="string">"1"</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></div></figure>
<blockquote>
<p>上述代码中，<code>beforeEach</code> 是 Mocha 提供的钩子函数，作用是：在每个测试用例（<code>it</code> 块）执行之前，都会执行一次。</p>
<p>类似的 Mocha 提供的钩子函数总共有四个：<code>before</code>, <code>after</code>, <code>beforeEach</code>, <code>afterEach</code>。它们的具体作用这里不再介绍。</p>
</blockquote>
<p>如果想要测试 DOM 相关的操作，我们需要在测试之前，向页面中添加需要用到的元素，例如上述示例代码中的 <code>document.body.innerHTML = '&lt;button id=&quot;btn&quot;&gt;0&lt;/button&gt;';</code>。</p>
<p>接着，我们在测试用例（<code>it</code> 块）中，获取了提前添加好的 DOM 元素，然后通过 <code>btn.click();</code> 来主动触发该元素的点击事件，从而模拟了用户操作。</p>
<p>最后，进行断言来完成测试：<code>expect(btn.innerText).to.equal('1');</code>。</p>
<blockquote>
<p>到此为止，读者可以访问<span class="exturl"><a class="exturl__link"   href="https://github.com/liuyib/karma-mocha-demo/commit/69748d28ac7cf17b6ac761fb3629055aa88590f2"  target="_blank" rel="noopener">这里</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>，查看所做的修改。</p>
</blockquote>

        <h2 id="汇报测试结果"   >
          <a href="#汇报测试结果" class="heading-link"><i class="fas fa-link"></i></a>汇报测试结果</h2>
      
<p>编写完测试代码后，执行测试指令 <code>npm run test</code>，Karma 会使用默认的报告器来汇报测试结果，如图所示：</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="/assets/posts/use-karma-mocha-chai-to-test/karma-default-reporter.png"  alt="" />
      </p>

    <div class="note-plugin success">
      <span class="note-plugin__icon note-plugin__icon--success">
              <i class="fas fa-check-circle"></i>
            </span>
      <p>如果你想使用默认的报告器，请直接跳过下面这段。</p>
    </div>
  
<p>这里列举几个常用的报告器插件：</p>
<ul>
<li><span class="exturl"><a class="exturl__link"   href="https://github.com/mlex/karma-spec-reporter"  target="_blank" rel="noopener">karma-spec-reporter</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link"   href="https://github.com/litixsoft/karma-mocha-reporter"  target="_blank" rel="noopener">karma-mocha-reporter</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link"   href="https://github.com/dgarlitt/karma-nyan-reporter"  target="_blank" rel="noopener">karma-nyan-reporter</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
</ul>
<blockquote>
<p>查看更多报告器插件请访问：<span class="exturl"><a class="exturl__link"   href="https://npmjs.org/browse/keyword/karma-reporter"  target="_blank" rel="noopener">https://npmjs.org/browse/keyword/karma-reporter</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</blockquote>
<blockquote>
<p>注意，这些插件的文档中指出了 <code>karma.conf.js</code> 中的 <code>plugins</code> 配置项。一般情况下，以 <code>karma-</code> 开头命名的插件，会自动被 Karma 引入，所以一般你不需要指定 <code>plugins</code> 配置项。但要知道，一旦你设置了 <code>plugins</code> 配置项，就必须引入<strong>所有</strong>以 <code>karma-</code> 开头的插件，否则请直接留空。</p>
</blockquote>
<p>本文以 <code>karma-spec-reporter</code> 作为示例，首先安装插件：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install --save-dev karma-spec-reporter</span><br></pre></td></tr></table></div></figure>
<p>配置也很简单，只需要修改 <code>karma.conf.js</code> 文件：</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">reporters: [<span class="string">'spec'</span>],</span><br><span class="line">...</span><br></pre></td></tr></table></div></figure>
<p>然后执行 <code>npm run test</code>，控制台会输出 “哪些测试用例通过了，哪些没通过”，如图所示：</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="/assets/posts/use-karma-mocha-chai-to-test/karma-spec-reporter.png"  alt="" />
      </p>
<blockquote>
<p>到此为止，读者可以访问<span class="exturl"><a class="exturl__link"   href="https://github.com/liuyib/karma-mocha-demo/commit/5db1630e08f9bfb73b781ee410e5acedda2ac6e8"  target="_blank" rel="noopener">这里</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>，查看所做的修改。</p>
</blockquote>

        <h2 id="生成覆盖率报告"   >
          <a href="#生成覆盖率报告" class="heading-link"><i class="fas fa-link"></i></a>生成覆盖率报告</h2>
      
<p>这里列举两个常用的生成覆盖率的插件：</p>
<ul>
<li><span class="exturl"><a class="exturl__link"   href="https://github.com/karma-runner/karma-coverage"  target="_blank" rel="noopener">karma-coverage</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link"   href="https://github.com/mattlewis92/karma-coverage-istanbul-reporter"  target="_blank" rel="noopener">karma-coverage-istanbul-reporter</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
</ul>
<p>其中 <code>karma-coverage</code> 是官方的插件，而 <code>karma-coverage-istanbul-reporter</code> 基于它进行了一些改进。在我使用的过程中，体验到它俩最大的不同是：生成 <code>text</code> 和 <code>text-summary</code> 类型的报告方式不同。前者会将这两种类型的报告生成到文件中，而后者会将这两种类型的报告生成到控制台中。本文以 <code>karma-coverage</code> 作为举例。</p>
<p>首先，安装 <code>karma-coverage</code> 插件：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install --save-dev karma-coverage</span><br></pre></td></tr></table></div></figure>
<p>然后，参照该插件的<span class="exturl"><a class="exturl__link"   href="https://github.com/karma-runner/karma-coverage"  target="_blank" rel="noopener">文档</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>进行配置，修改 <code>karma.conf.js</code> 文件：</p>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">preprocessors: &#123;</span><br><span class="line">  <span class="string">'src/**/*.js'</span>: [<span class="string">'webpack'</span>, <span class="string">'coverage'</span>],</span><br><span class="line">  <span class="string">'test/**/*.js'</span>: [<span class="string">'webpack'</span>]</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">reporters: [<span class="string">'spec'</span>, <span class="string">'coverage'</span>],</span><br><span class="line"></span><br><span class="line">coverageReporter: &#123;</span><br><span class="line">  <span class="comment">// 生成报告的目录</span></span><br><span class="line">  dir: <span class="string">'coverage/'</span>,</span><br><span class="line">  <span class="comment">// 要生成的报告类型</span></span><br><span class="line">  reporters: [</span><br><span class="line">    &#123; <span class="attr">type</span>: <span class="string">'lcov'</span>, <span class="attr">subdir</span>: <span class="string">'.'</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">type</span>: <span class="string">'text'</span>, <span class="attr">subdir</span>: <span class="string">'.'</span>, <span class="attr">file</span>: <span class="string">'text.txt'</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">type</span>: <span class="string">'text-summary'</span>, <span class="attr">subdir</span>: <span class="string">'.'</span>, <span class="attr">file</span>: <span class="string">'text-summary.txt'</span> &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></div></figure>
<p>执行测试指令 <code>npm run test</code>，会生成 <code>coverage</code> 目录，并在该目录下生成覆盖率报告。</p>
<blockquote>
<p>这里需要介绍一下几种常用的报告类型：</p>
<ul>
<li><code>html</code> 报告类型<br />
这是给人看的覆盖率报告。默认会生成一个 <code>lcov-report</code> 文件夹。</li>
<li><code>lcovonly</code> 报告类型<br />
这是给 CI 用的，默认生成的文件名为 <code>lcov.info</code>。</li>
<li><code>lcov</code> 报告类型<br />
该报告类型 == <code>html</code> 报告类型 + <code>lcovonly</code> 报告类型</li>
<li><code>text-summary</code> 报告类型（效果如下）<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; Coverage summary &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">Statements   : 54.02% ( 47&#x2F;87 )</span><br><span class="line">Branches     : 19.23% ( 10&#x2F;52 )</span><br><span class="line">Functions    : 56.52% ( 13&#x2F;23 )</span><br><span class="line">Lines        : 61.64% ( 45&#x2F;73 )</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br></pre></td></tr></table></div></figure>
</li>
<li><code>text</code> 报告类型（效果如下）<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">----------|----------|----------|----------|----------|-------------------|</span><br><span class="line">File      |  % Stmts | % Branch |  % Funcs |  % Lines | Uncovered Line #s |</span><br><span class="line">----------|----------|----------|----------|----------|-------------------|</span><br><span class="line">All files |    54.02 |    19.23 |    56.52 |    61.64 |                   |</span><br><span class="line"> main.js  |    54.55 |    19.23 |    58.33 |    62.16 |... 69,70,71,72,73 |</span><br><span class="line"> utils.js |    53.49 |    19.23 |    54.55 |    61.11 |... 69,70,71,72,73 |</span><br><span class="line">----------|----------|----------|----------|----------|-------------------|</span><br></pre></td></tr></table></div></figure>
一般情况下，常用的报告类型就是 <code>lcov</code>, <code>text</code>, <code>text-summary</code> 这三种。你可以访问<span class="exturl"><a class="exturl__link"   href="https://istanbul.js.org/docs/advanced/alternative-reporters/"  target="_blank" rel="noopener">这里</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>，查看所有报告类型的格式和作用。</li>
</ul>
</blockquote>
<p>找到 <code>coverage/lcov-report</code> 目录中的 <code>index.html</code> 文件，将其在浏览器中运行，可以查看到详细的覆盖率报告信息，如图所示：</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="/assets/posts/use-karma-mocha-chai-to-test/coverage-in-browser-1.png"  alt="" />
      </p>
<blockquote>
<p>到此为止，读者可以访问<span class="exturl"><a class="exturl__link"   href="https://github.com/liuyib/karma-mocha-demo/commit/0b70ec801aabdfd60ddd4e5c0b17e089c51872bd"  target="_blank" rel="noopener">这里</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>，查看所做的修改。</p>
</blockquote>
<p>本文的示例代码中，理论上测试覆盖率应该是 100%，但是实际并没有这么多。而且，细心的话可以发现，代码的总行数也变多了，这是因为 webpack 会在编译之后加入一些代码，影响了覆盖率。为了解决这个问题，有两个插件可供选择：</p>
<ul>
<li><span class="exturl"><a class="exturl__link"   href="https://github.com/istanbuljs/babel-plugin-istanbul"  target="_blank" rel="noopener">babel-plugin-istanbul</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link"   href="https://github.com/webpack-contrib/istanbul-instrumenter-loader"  target="_blank" rel="noopener">istanbul-instrumenter-loader</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
</ul>
<p>如果你的项目只使用了 Babel，没有使用 webpack，那么你只能使用 <code>babel-plugin-istanbul</code> 来解决这个问题。如果你的项目使用了 webpack，那么两个插件可以任选其一来使用。</p>
<p>由于本文示例中用到了 webpack，所以这两个插件可以任选其一，我们以 <code>babel-plugin-istanbul</code> 为例：</p>
<p>首先，安装该插件：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install --save-dev babel-plugin-istanbul</span><br></pre></td></tr></table></div></figure>
<p>然后，参照其文档进行配置，修改 <code>karma.conf.js</code> 文件：</p>
<figure class="highlight diff"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">webpack: &#123;</span><br><span class="line">  mode: 'development',</span><br><span class="line">  module: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: /\.js$/,</span><br><span class="line">        exclude: /(node_modules|bower_components)/,</span><br><span class="line">        use: &#123;</span><br><span class="line">          loader: 'babel-loader',</span><br><span class="line">          options: &#123;</span><br><span class="line">            presets: ['@babel/preset-env'],</span><br><span class="line"><span class="addition">+           plugins: ['istanbul']</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></div></figure>
<p>如果将该配置放入 <code>.babelrc</code> 文件，则如下所示：</p>
<figure class="highlight diff"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// .babelrc</span><br><span class="line">&#123;</span><br><span class="line">  "presets": ["@babel/preset-env"],</span><br><span class="line"><span class="addition">+ "plugins": ["istanbul"]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>再次执行测试指令 <code>npm run test</code>，即可得到 100% 的覆盖率，如图所示：</p>
<p>
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="/assets/posts/use-karma-mocha-chai-to-test/coverage-in-browser-2.png"  alt="" />
      </p>
<blockquote>
<p>如果你使用 <code>karma-coverage-istanbul-reporter</code> 插件来生成覆盖率，可能会遇到覆盖率信息全为 <code>0</code> 或 <code>Unknown</code> 的情况。这个问题和上述覆盖率统计不正确类似，都是由于插件默认无法统计 ES6+ 代码引起的。你只需要按照上文中的说明，使用 <code>babel-plugin-istanbul</code> 或 <code>istanbul-instrumenter-loader</code> 插件即可解决此类问题。</p>
</blockquote>
<blockquote>
<p>到此为止，读者可以访问<span class="exturl"><a class="exturl__link"   href="https://github.com/liuyib/karma-mocha-demo/commit/8ec8303fd703a9681ca6b3f96ff1bab5a3ba8495"  target="_blank" rel="noopener">这里</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>，查看所做的修改。</p>
</blockquote>

        <h2 id="持续集成"   >
          <a href="#持续集成" class="heading-link"><i class="fas fa-link"></i></a>持续集成</h2>
      
<p>常用的持续集成工具有 <span class="exturl"><a class="exturl__link"   href="https://travis-ci.com/"  target="_blank" rel="noopener">Travis CI</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 和 <span class="exturl"><a class="exturl__link"   href="https://circleci.com/"  target="_blank" rel="noopener">CircleCI</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>。本文以 Travis CI 作为举例。</p>

        <h3 id="配置-travis-ci"   >
          <a href="#配置-travis-ci" class="heading-link"><i class="fas fa-link"></i></a>配置 Travis CI</h3>
      
<p>由于 Travis CI 是在命令行中运行，因此跑不了 GUI 程序。如果要在 Travis CI 中运行需要 GUI 的测试，则要用到 <code>xvfb</code>（X Virtual Framebuffer）来模拟显示。详见：<span class="exturl"><a class="exturl__link"   href="https://docs.travis-ci.com/user/gui-and-headless-browsers/#using-xvfb-to-run-tests-that-require-a-gui"  target="_blank" rel="noopener">Using xvfb to Run Tests That Require a GUI</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>。</p>
<p>新建 Travis CI 的配置文件 <code>.travis.yml</code>，并编写以下内容：</p>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">language:</span> <span class="string">node_js</span></span><br><span class="line"></span><br><span class="line"><span class="attr">node_js:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 xvfb 来模拟显示 GUI</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">xvfb</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定要使用的浏览器以及版本</span></span><br><span class="line"><span class="attr">addons:</span></span><br><span class="line"><span class="attr">  chrome:</span> <span class="string">stable</span></span><br><span class="line"></span><br><span class="line"><span class="attr">script:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">test</span></span><br><span class="line"></span><br><span class="line"><span class="attr">after_script:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">codecov</span></span><br></pre></td></tr></table></div></figure>
<p>除了配置 Travis CI 外，我们还需要配置 Krama，修改 <code>karma.conf.js</code> 文件：</p>
<blockquote>
<p>如果你不准备使用 CI，请忽略该配置，默认即可。</p>
</blockquote>
<figure class="highlight js"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">// 如果设为 true 的话，Karma 将捕获浏览器，运行测试，并自动退出</span></span><br><span class="line"><span class="comment">// process.env.CI 是环境变量，在 CI 中值为 true，否则值为 false</span></span><br><span class="line">singleRun: !!process.env.CI,</span><br><span class="line">...</span><br></pre></td></tr></table></div></figure>
<p>该配置项默认为 <code>false</code>，会使得 Karma 在测试结束后仍然监听文件变化，不会退出测试，但是在 CI 中必须在测试结束后退出测试，否则 CI 将会一直等待，直到超时。</p>

        <h3 id="上传覆盖率"   >
          <a href="#上传覆盖率" class="heading-link"><i class="fas fa-link"></i></a>上传覆盖率</h3>
      
<p>生成了覆盖率，配置了 CI，最后还需要做的是，将覆盖率上传到 <span class="exturl"><a class="exturl__link"   href="https://coveralls.io/"  target="_blank" rel="noopener">Coveralls</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 或 <span class="exturl"><a class="exturl__link"   href="https://codecov.io/"  target="_blank" rel="noopener">Codecov</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 中进行分析。本文以 Codecov 为例。</p>
<p>首先，安装 <code>codecov</code> 插件：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install --save-dev codecov</span><br></pre></td></tr></table></div></figure>
<p>然后，参照该插件的<span class="exturl"><a class="exturl__link"   href="https://github.com/codecov/codecov-node"  target="_blank" rel="noopener">文档</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>进行配置，添加一个 NPM 指令，修改 <code>package.json</code> 文件：</p>
<figure class="highlight diff"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">"script": &#123;</span><br><span class="line">  "test": "karma start ./karma.conf.js",</span><br><span class="line"><span class="addition">+ "codecov": "./node_modules/.bin/codecov"</span></span><br><span class="line">&#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></div></figure>
<p>该指令的作用是：读取 <code>coverage</code> 目录中的 <code>lcov.info</code> 文件，然后上传到 Codecov 网站。</p>
<blockquote>
<p>在上传覆盖率之前，你最好确认一下当你执行 <code>npm run test</code> 指令后，可以在 <code>coverage</code> 目录中生成 <code>lcov.info</code> 文件。</p>
</blockquote>
<blockquote>
<p>到此为止，读者可以访问<span class="exturl"><a class="exturl__link"   href="https://github.com/liuyib/karma-mocha-demo/commit/cef265c71b6d0c002cd83863d53a434d8a0e01fe"  target="_blank" rel="noopener">这里</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>，查看所做的修改。</p>
</blockquote>

        <h3 id="展示徽章"   >
          <a href="#展示徽章" class="heading-link"><i class="fas fa-link"></i></a>展示徽章</h3>
      
<p>最后，我们把测试的结果，以 Travis CI 和 Codecov 徽章的形式放入 README。例如，本文配套的 Github 仓库 <span class="exturl"><a class="exturl__link"   href="https://github.com/liuyib/karma-mocha-demo"  target="_blank" rel="noopener">karma-mocha-demo</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 的测试结果：</p>
<p><a href="https://travis-ci.com/github/liuyib/karma-mocha-demo" target="_blank" rel="noopener">
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://img.shields.io/travis/liuyib/karma-mocha-demo.svg"  alt="Travis CI" />
      </a><br />
<a href="https://codecov.io/gh/liuyib/karma-mocha-demo" target="_blank" rel="noopener">
        <img   class="lazyload lazyload-gif"
          src="/images/loading.svg" data-src="https://img.shields.io/codecov/c/github/liuyib/karma-mocha-demo.svg"  alt="Codecov" />
      </a></p>
<p>对应代码如下：</p>
<figure class="highlight md"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">![Travis CI</span>](<span class="link">https://img.shields.io/travis/liuyib/karma-mocha-demo.svg</span>)](<span class="link">https://travis-ci.com/github/liuyib/karma-mocha-demo</span>)</span><br><span class="line">[<span class="string">![Codecov</span>](<span class="link">https://img.shields.io/codecov/c/github/liuyib/karma-mocha-demo.svg</span>)](<span class="link">https://codecov.io/gh/liuyib/karma-mocha-demo</span>)</span><br></pre></td></tr></table></div></figure>
<p>将其中的用户名（<code>liuyib</code>）和仓库名（<code>karma-mocha-demo</code>）换成你的即可。</p>
<hr />
<p>参考资料：</p>
<ul>
<li><span class="exturl"><a class="exturl__link"   href="https://blog.crimx.com/2019/06/19/%E6%90%AD%E5%BB%BA-karma-mocha-chai-%E6%B5%8B%E8%AF%95-typescript-%E9%A1%B9%E7%9B%AE/"  target="_blank" rel="noopener">搭建 Karma+Mocha+Chai 测试 TypeScript 项目</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link"   href="http://www.ruanyifeng.com/blog/2015/12/a-mocha-tutorial-of-examples.html"  target="_blank" rel="noopener">测试框架 Mocha 实例教程</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link"   href="https://www.cnblogs.com/tugenhua0707/p/8433847.html"  target="_blank" rel="noopener">学习 Karma+Jasmine+istanbul+webpack 自动化单元测试</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link"   href="https://www.ibm.com/developerworks/cn/web/wa-lo-use-karma-jasmine-build-test-environment/index.html"  target="_blank" rel="noopener">使用 Karma + Jasmine 构建 Web 测试环境</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link"   href="https://benlimmer.com/2019/01/14/travis-ci-xvfb/"  target="_blank" rel="noopener">Travis CI XVFB Breaking Change</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
</ul>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="https://liuyib.github.io">liuyib</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="https://liuyib.github.io/2020/03/20/use-karma-mocha-chai-to-test/">https://liuyib.github.io/2020/03/20/use-karma-mocha-chai-to-test/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">版权声明: </span><span class="copyright-notice__value">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://liuyib.github.io/tags/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/">单元测试</a></span><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://liuyib.github.io/tags/Karma/">Karma</a></span><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://liuyib.github.io/tags/Mocha/">Mocha</a></span><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://liuyib.github.io/tags/Chai/">Chai</a></span></div><div class="post-reward reward"><div class="reward-button">请我喝杯咖啡~</div><div class="reward-qrcode"><span class="reward-qrcode-alipay"><img class="reward-qrcode-alipay__img" src="/assets/others/alipay.png"><div class="reward-qrcode-alipay__text">支付宝打赏</div></span><span class="reward-qrcode-wechat"><img class="reward-qrcode-wechat__img" src="/assets/others/wechat.png"><div class="reward-qrcode-wechat__text">微信打赏</div></span></div></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2020/04/07/css-h-and-v-center/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">CSS 拷问：水平垂直居中方法你会几种？</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2019/09/24/use-pjax-to-your-site/"><span class="paginator-prev__text">集成 Pjax 实现网站无刷新加载</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div><div class="comments" id="comments"><div id="disqus_thread"></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#适用场景"><span class="toc-number">1.</span> <span class="toc-text">
          适用场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么不用-jest"><span class="toc-number">2.</span> <span class="toc-text">
          为什么不用 Jest</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#认识-karma"><span class="toc-number">3.</span> <span class="toc-text">
          认识 Karma</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用-karma"><span class="toc-number">4.</span> <span class="toc-text">
          使用 Karma</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装插件"><span class="toc-number">5.</span> <span class="toc-text">
          安装插件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编写代码"><span class="toc-number">6.</span> <span class="toc-text">
          编写代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用-babel"><span class="toc-number">7.</span> <span class="toc-text">
          使用 Babel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置-webpack"><span class="toc-number">8.</span> <span class="toc-text">
          配置 webpack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#启动-karma"><span class="toc-number">9.</span> <span class="toc-text">
          启动 Karma</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编写测试代码"><span class="toc-number">10.</span> <span class="toc-text">
          编写测试代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#汇报测试结果"><span class="toc-number">11.</span> <span class="toc-text">
          汇报测试结果</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#生成覆盖率报告"><span class="toc-number">12.</span> <span class="toc-text">
          生成覆盖率报告</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#持续集成"><span class="toc-number">13.</span> <span class="toc-text">
          持续集成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#配置-travis-ci"><span class="toc-number">13.1.</span> <span class="toc-text">
          配置 Travis CI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#上传覆盖率"><span class="toc-number">13.2.</span> <span class="toc-text">
          上传覆盖率</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#展示徽章"><span class="toc-number">13.3.</span> <span class="toc-text">
          展示徽章</span></a></li></ol></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="https://cdn.jsdelivr.net/gh/liuyib/picBed@master/avatar.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">write code and love life</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/liuyib/" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="https://segmentfault.com/u/liuyib/" target="_blank" rel="noopener" data-popover="思否" data-popover-pos="up"><span class="sidebar-ov-social-item__icon">SF</span></a><a class="sidebar-ov-social-item" href="https://www.zhihu.com/people/liu-yibo-64-65/activities/" target="_blank" rel="noopener" data-popover="知乎" data-popover-pos="up"><span class="sidebar-ov-social-item__icon">知乎</span></a><a class="sidebar-ov-social-item" href="https://juejin.im/user/5ad6b350f265da2397076275/" target="_blank" rel="noopener" data-popover="掘金" data-popover-pos="up"><span class="sidebar-ov-social-item__icon">掘金</span></a></div><div class="sidebar-ov-feed"><span class="sidebar-ov-feed-email"><a class="sidebar-ov-feed-email__link" href="http://eepurl.com/guAE6j" target="_blank" rel="noopener"><span class="sidebar-ov-feed-email__icon"><i class="fas fa-envelope"></i></span><span>Email 订阅</span></a></span><span class="sidebar-ov-feed-rss"><a class="sidebar-ov-feed-rss__link" href="/atom.xml" target="_blank" rel="noopener"><span class="sidebar-ov-feed-rss__icon"><i class="fas fa-rss"></i></span><span>RSS 订阅</span></a></span></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2019~2020</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span><a href="https://github.com/liuyib" rel="noopener" target="_blank">liuyib</a></span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v4.0.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.1.1</span></div><div class="busuanzi"><span class="busuanzi-siteuv"><span class="busuanzi-siteuv__icon"><i class="fas fa-user"></i></span><span class="busuanzi-siteuv__info">访问人数</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_uv"></span></span><span class="busuanzi-sitepv"><span class="busuanzi-siteuv__icon"><i class="fas fa-eye"></i></span><span class="busuanzi-siteuv__info">浏览总量</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_pv"></span></span></div><div>托管于 <a href="https://github.com/liuyib/liuyib.github.io/tree/hexo" rel="noopener" target="_blank">Github</a></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/ribbon.js@latest/dist/ribbon.min.js" size="120" alpha="0.6" zIndex="-1"></script><script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lazyload@2.0.0-rc.2/lazyload.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ 文章无标题 ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);</script><script src="https://cdn.jsdelivr.net/npm/pjax@latest/pjax.min.js"></script><script>window.addEventListener('DOMContentLoaded', function () {
  var pjax = new Pjax({"selectors":["head title","#main",".pjax-reload"],"history":true,"scrollTo":false,"scrollRestoration":false,"cacheBust":false,"debug":false,"currentUrlFullReload":false,"timeout":0});
  // 加载进度条的计时器
  var loadingTimer = null;

  // 重置页面 Y 方向上的滚动偏移量
  document.addEventListener('pjax:send', function () {
    $('.header-nav-menu').removeClass('show');
    if (CONFIG.pjax && CONFIG.pjax.avoidBanner) {
      $('html').velocity('scroll', {
        duration: 500,
        offset: $('#header').height(),
        easing: 'easeInOutCubic'
      });
    }

    var loadingBarWidth = 20;
    var MAX_LOADING_WIDTH = 95;

    $('.loading-bar').addClass('loading');
    $('.loading-bar__progress').css('width', loadingBarWidth + '%');
    clearInterval(loadingTimer);
    loadingTimer = setInterval(function () {
      loadingBarWidth += 3;
      if (loadingBarWidth > MAX_LOADING_WIDTH) {
        loadingBarWidth = MAX_LOADING_WIDTH;
      }
      $('.loading-bar__progress').css('width', loadingBarWidth + '%');
    }, 500);
  }, false);

  window.addEventListener('pjax:complete', function () {
    clearInterval(loadingTimer);
    $('.loading-bar__progress').css('width', '100%');
    $('.loading-bar').removeClass('loading');
    setTimeout(function () {
      $('.loading-bar__progress').css('width', '0');
    }, 400);
    $('link[rel=prefetch], script[data-pjax-rm]').each(function () {
      $(this).remove();
    });
    $('script[data-pjax], #pjax-reload script').each(function () {
      $(this).parent().append($(this).remove());
    });

    if (Stun.utils.pjaxReloadBoot) {
      Stun.utils.pjaxReloadBoot();
    }
    if (Stun.utils.pjaxReloadScroll) {
      Stun.utils.pjaxReloadScroll();
    }
    if (Stun.utils.pjaxReloadSidebar) {
      Stun.utils.pjaxReloadSidebar();
    }
    if (false) {
      if (Stun.utils.pjaxReloadHeader) {
        Stun.utils.pjaxReloadHeader();
      }
      if (Stun.utils.pjaxReloadScrollIcon) {
        Stun.utils.pjaxReloadScrollIcon();
      }
      if (Stun.utils.pjaxReloadLocalSearch) {
        Stun.utils.pjaxReloadLocalSearch();
      }
    }
  }, false);
}, false);</script><div id="pjax-reload"><script src="https://cdn.jsdelivr.net/npm/quicklink@1.0.1/dist/quicklink.umd.js"></script><script>function initQuicklink() {
  quicklink({
    timeout: '10000',
    priority: true,
    ignores: [uri => uri.includes('#'), uri => uri === 'https://liuyib.github.io/2020/03/20/use-karma-mocha-chai-to-test/', /\/api\/?/,uri => uri.includes('.xml'),uri => uri.includes('.zip'),(uri, el) => el.hasAttribute('nofollow'),(uri, el) => el.hasAttribute('noprefetch')]
  });
}

if (true || false) {
  initQuicklink();
} else {
  window.addEventListener('DOMContentLoaded', initQuicklink, false);
}</script><script src="https://cdn.jsdelivr.net/gh/sukkaw/busuanzi@latest/bsz.pure.mini.js" async></script></div><script data-pjax="">function loadDisqus () {
  if (!document.getElementById('disqus_thread')) {
    return;
  }
  if (window.DISQUS) {
    DISQUS.reset({
      reload: true,
      config: function () {
        this.page.url = 'https://liuyib.github.io/2020/03/20/use-karma-mocha-chai-to-test/';
        this.page.identifier = '2020/03/20/use-karma-mocha-chai-to-test/';
        this.page.title = '使用 Karma + Mocha + Chai 搭建 Web 单元测试环境';
      }
    });
  } else {
    var d = document;
    var sc = d.createElement('script');
    var se = d.createElement('script');

    if (true) {
      sc.src = 'https://liuyib.disqus.com/count.js';
      sc.id = 'dsq-count-scr';
      sc.async = true;
      if (true) {
        sc.setAttribute('data-pjax', '');
      }
      (d.head || d.body).appendChild(sc);
    }
    se.src = 'https://liuyib.disqus.com/embed.js';
    (d.head || d.body).appendChild(se);
  }
}

if (true) {
  loadDisqus();
} else {
  window.addEventListener('DOMContentLoaded', loadDisqus, false);
}</script><script src="/js/utils.js?v=2.1.1"></script><script src="/js/stun-boot.js?v=2.1.1"></script><script src="/js/scroll.js?v=2.1.1"></script><script src="/js/header.js?v=2.1.1"></script><script src="/js/sidebar.js?v=2.1.1"></script><script type="application/json" src="/search.json"></script><script>if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js?t=1601801027748')
    .then(function () {console.log('ServiceWorker Register Successfully.')})
    .catch(function (e) {console.error(e)});
}
</script></body></html>